name: Applitools

on:
  workflow_dispatch:
  workflow_call:
    secrets:
      APPLITOOLS_API_KEY:
        required: true
    inputs:
      batch-id:
        type: string

env:
  APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
  APPLITOOLS_BATCH_ID: ${{ inputs.batch-id || github.ref_name }}
  APPLITOOLS_BRANCH_NAME: "lumada-design/hv-uikit-react/master"

jobs:
  run-tests:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        uses: ./.github/actions/install-dependencies

      - name: Start storybook
        run: npm run build:doc && npx -y http-server dist -p 6006 &

      - name: Wait for storybook to be ready
        shell: bash
        run: |
          count=300
          until $(curl --output /dev/null --silent --head --fail http://127.0.0.1:6006); do
              if [ $count -eq 0 ]; then exit 1; fi
              printf '.'
              sleep 1
              let "count--"
          done

      - name: Set Applitools App Name
        id: set-app-name
        run: |
          if [[ "${{ github.ref_name }}" == "next"* ]]; then
            echo "APPLITOOLS_APP_NAME=NEXT UI Kit" >> $GITHUB_ENV
          else
          echo "APPLITOOLS_APP_NAME=UI Kit" >> $GITHUB_ENV
          fi

      - name: Eyes Storybook
        run: npm run test:eyes
        timeout-minutes: 30
